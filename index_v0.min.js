"use strict";console.log("index.js Start");import{a,button,ClassList,div,doomHelperDebug,footer,h1,h2,h3,img,input,li,nav,QueryRouter,RouterLazyLoad,ShowIf,Signal,span,svg,text,TextState,ul}from"./res/domHelper_v0.min.js";const apiEndPoint="localhost"===window.location.hostname?"https://localhost/api":"https://api.simon.chummydns.com/api",mobileWidth=700;window.fetchApi=function(e,o,n){let t;if(n?n.credentials="include":n={credentials:"include"},window.AbortController&&n.timeout){const e=new AbortController;n.signal=e.signal,t=setTimeout((()=>e.abort()),n.timeout)}const i=o?requestState.addState(o):null;return fetch(apiEndPoint+e,n).then((e=>e.json())).then((e=>(t&&clearTimeout(t),e.success||window.messageAlert.addError("Api response error",e.err.join("\n"),2e3),i&&requestState.removeState(i),e))).catch((e=>("AbortError"===e.name?window.messageAlert.addError("Api response timeout","Try again later",3e3):window.messageAlert.addError("Network error",e instanceof Error?e.stack||e||"Unknown error!":e,2e3),i&&requestState.removeState(i),null)))},window.askForLoginAlert=()=>window.messageAlert.addInfo("Login to use this page","Click login button at top right corner to login in",3e3),window.loadingElement=svg('<circle class="path" cx="25" cy="25" r="20" fill="none" stroke-width="5" stroke-linecap="square"/>',"0 0 50 50","loaderCircle"),window.navMenu=new ClassList("links"),window.pageLoading=new Signal(!1),function(){console.log("index.js Init"),window.messageAlert=function(){const e=div("messageBox");function o(){t(this.parentElement)}function n(n,i,l,s){const a=div(n,span(i,"title"),span(l,"description"),div("closeButton",{onclick:o}));void 0!==s&&(a.removeTimeout=setTimeout((()=>t(a)),s)),e.childElementCount>0?e.insertBefore(a,e.firstElementChild):e.appendChild(a),a.style.marginTop=-a.offsetHeight+"px",setTimeout((()=>a.classList.add("animation")))}function t(o){clearTimeout(o.removeTimeout),o.style.opacity="0",o.style.marginTop=-o.offsetHeight+"px",setTimeout((()=>{e.removeChild(o)}),500)}return e.addInfo=function(e,o,t){n("info",e,o,t)},e.addError=function(e,o,t){n("error",e,o,t)},e.addSuccess=function(e,o,t){n("success",e,o,t)},e}(),window.requestState=function(){const e=div("stateBox noSelect");return e.addState=function(o){return e.appendChild(div(null,window.loadingElement.cloneNode(!0),h1(o,"title")))},e.removeState=function(o){e.removeChild(o)},e}();let e=null;if("localhost"===location.hostname){if(console.log("Debug enabled"),doomHelperDebug(),window.performance&&window.performance.memory){const o=new Signal(window.performance.memory);setInterval((()=>o.set(window.performance.memory)),1e3),e=span(TextState(o,(e=>(e.usedJSHeapSize/1e3/1e3).toFixed(2)+"MB")),null,{style:"position: absolute; top: 0; z-index: 100; background: black; font-size: 10px; opacity: 0.5;"})}}else console.log("Debug disable");const o={Home:"成功大學課程資訊及選課系統",CourseSearch:"課程查詢",Schedule:"課表",GradeInquiry:"成績查詢",CourseSelectionPreference:"志願排序"},n=new Signal,t=new Signal(!1),i=new QueryRouter("NCKU++",o,"Home",{Home:new RouterLazyLoad("./pages/home.js"),CourseSearch:new RouterLazyLoad("./pages/courseSearch.js",n),Schedule:new RouterLazyLoad("./pages/courseSchedule.js",n),GradeInquiry:new RouterLazyLoad("./pages/stuIdSysGrades.js",n),CourseSelectionPreference:new RouterLazyLoad("./pages/preferenceAdjust.js",n)},footer(div("borderLine"),div("source",h2("資料來源"),a(null,"https://course.ncku.edu.tw/","noSelect",null,{target:"_blank"},img("https://course.ncku.edu.tw/acadcdn/images/Logo_course.png","noDrag",{alt:"NCKUCourse logo"})),a(null,"https://nckuhub.com/","noSelect",null,{target:"_blank"},img("https://nckuhub.com/dist/images/table/nav_logo.svg","noDrag",{alt:"NCKUHub logo"})),a(null,"https://urschool.org/","noSelect",null,{target:"_blank"},img("res/assets/UrSchool_logo.png","noDrag",{alt:"UrSchool logo"}))),div("splitLine"),h3("By WavJaby"),h3("Email: WavJaby@gmail.com"),a(null,"https://github.com/WavJaby/NCKUpp","openRepo noSelect",null,{target:"_blank"},img("./res/assets/github_icon.svg","githubIcon noDrag",{alt:"GitHub icon"}),span("GitHub repo"))));console.log("QueryRouter ready");const l={};for(const e in o)"Home"!==e&&(l[e]=li(null,a(o[e],"./?page="+e,null,r,{pageId:e})));i.onPageOpen=function(e,o){const n=l[e];e&&n&&n.classList.remove("opened");const t=l[o];t&&t.classList.add("opened")},console.log("PageButtons ready"),window.fetchApi("/login","Check login").then(u),console.log("Check login state");const s=div("root",nav("navbar noSelect",function(e,o,n,t,i){const l=ul(null),s=ul(e?"list "+e:"list",t?{onmouseleave:a,onmouseenter:function(){window.innerWidth>700&&(s.style.height=s.firstElementChild.offsetHeight+s.lastElementChild.offsetHeight+"px")}}:null,li("items",l),li("title",o,{onclick:function(){if(i&&!i()&&!s.style.height)return;s.style.height?s.style.height=null:s.style.height=s.firstElementChild.offsetHeight+s.lastElementChild.offsetHeight+"px"}}));for(const e of n){const o=e[1];l.appendChild(li(null,text(e[0]),{onclick:o?()=>{o(),a()}:a}))}function a(){s.style.height=null}return s}("loginBtn",span(TextState(n,(e=>e&&e.login?e.studentID:"Login"))),[["Profile",null],["Logout",()=>window.fetchApi("/logout").then(u)]],!1,(()=>!(!n.state||!n.state.login)||(t.set(!t.state),!1))),ul("hamburgerMenu",li(null,img("./res/assets/burger_menu_icon.svg","noDrag",{alt:"mobile menu button",onclick:()=>window.navMenu.toggle("open")}))),ul("homePage",li(null,a("NCKU++","./?page=Home",null,r,{pageId:"Home"}))),ul(window.navMenu,Object.values(l))),i.element,ShowIf(t,function(e){const o=input("loginField","Account",null,{onkeyup:i,type:"text"}),n=input("loginField","Password",null,{onkeyup:i,type:"password"});let t=!1;function i(e){"Enter"===e.key&&l()}function l(){if(!t){t=!0,window.pageLoading.set(!0);const i=o.value.endsWith("@ncku.edu.tw")?o:o.value+"@ncku.edu.tw";window.fetchApi("/login","login",{method:"POST",body:`username=${encodeURIComponent(i)}&password=${encodeURIComponent(n.value)}`,timeout:1e4}).then((o=>{t=!1,window.pageLoading.set(!1),e(o)}))}}return div("loginWindow",{onRender:()=>o.focus()},o,n,button("loginField","Login",l,{type:"submit"}))}(u)),ShowIf(window.pageLoading,div("loading",window.loadingElement.cloneNode(!0))),window.messageAlert,requestState,e);function r(e){e.preventDefault();const o=this.pageId;return i.openPage(o),!1}function u(e){if(!e)return void window.messageAlert.addError("Network error","Try again later",3e3);const o=e.data;o?o.login||!e.msg?(n.set(o),t.set(!1)):window.messageAlert.addError("Login failed",e.msg,5e3):window.messageAlert.addError("Unknown login error","Try again later",3e3)}console.log("RootElement ready"),window.onload=()=>{console.log("Page loaded"),document.body.innerHTML="",document.body.appendChild(s),i.init()}}(),window.timeParseSection=function(e){let o;return"N"===e?o=5:(o=parseInt(e,16),o>4&&++o),o},window.timeParse=function(e){const o=e.split(","),n=new Int8Array(3);return n[0]=parseInt(o[0]),o.length>1&&(n[1]=window.timeParseSection(o[1])),o.length>2?n[2]=window.timeParseSection(o[2]):o.length>1&&(n[2]=n[1]),n};